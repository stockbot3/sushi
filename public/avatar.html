<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sushi - Avatar Commentary</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script>window.react = window.React;</script>
  <script src="https://unpkg.com/lucide-react@0.460.0/dist/umd/lucide-react.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- PixiJS -->
  <script src="https://cdn.jsdelivr.net/npm/pixi.js@7.3.2/dist/pixi.min.js"></script>
  
  <!-- Live2D Framework -->
  <script src="https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: {
            dark: { 900: '#0a0a0f', 800: '#12121a', 700: '#1a1a25', 600: '#222230' }
          }
        }
      }
    }
  </script>
  
  <style>
    body { background: #0a0a0f; color: white; }
    .avatar-stage {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 40px;
      padding: 40px;
      min-height: 500px;
      position: relative;
    }
    .avatar-container {
      position: relative;
      width: 350px;
      height: 450px;
      transition: all 0.3s ease;
    }
    .avatar-container.speaking {
      transform: scale(1.05);
      filter: drop-shadow(0 0 30px rgba(255,184,28,0.4));
      z-index: 10;
    }
    .avatar-container.listening {
      transform: scale(0.95);
      opacity: 0.8;
    }
    .avatar-canvas {
      width: 100%;
      height: 100%;
    }
    .avatar-info {
      text-align: center;
      margin-top: 16px;
    }
    .lip-sync-bar {
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      margin-top: 8px;
      overflow: hidden;
    }
    .lip-sync-fill {
      height: 100%;
      background: linear-gradient(90deg, #FFB81C, #FF6B35);
      width: 0%;
      transition: width 0.05s linear;
    }
    .vs-badge {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #FFB81C, #FF6B35);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 14px;
      color: #000;
      z-index: 5;
    }
    .subtitle-box {
      text-align: center;
      padding: 24px;
      background: rgba(0,0,0,0.4);
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .controls-panel {
      padding: 20px;
      background: rgba(255,255,255,0.03);
      border-top: 1px solid rgba(255,255,255,0.06);
    }
    .loading-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.8);
      border-radius: 12px;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #FFB81C;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;
    const { Mic, Play, Pause, SkipForward, Volume2, Settings, ArrowLeft } = LucideReact;

    // Simple TTS using Web Speech API (Piper would need WASM setup)
    class SimpleTTS {
      constructor() {
        this.synth = window.speechSynthesis;
      }

      async speak(text, onAudioData = null) {
        return new Promise((resolve) => {
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.rate = 1.0;
          utterance.pitch = 1.0;
          
          // Create synthetic audio analysis for lip-sync
          let interval;
          if (onAudioData) {
            const fakeAnalyser = {
              getByteFrequencyData: (array) => {
                for (let i = 0; i < array.length; i++) {
                  array[i] = Math.random() * 200 + 55;
                }
              }
            };
            
            interval = setInterval(() => {
              onAudioData(fakeAnalyser);
            }, 50);
          }
          
          utterance.onend = () => {
            if (interval) clearInterval(interval);
            resolve();
          };
          
          this.synth.speak(utterance);
        });
      }

      stop() {
        this.synth.cancel();
      }
    }

    // Live2D Avatar Component using Pixi.js
    function Live2DAvatar({ modelPath, name, teamColor, teamAbbr, isSpeaking, lipSyncValue }) {
      const containerRef = useRef(null);
      const [isLoading, setIsLoading] = useState(true);
      const [error, setError] = useState(null);
      const modelRef = useRef(null);
      const appRef = useRef(null);
      const lipSyncRef = useRef(0);

      useEffect(() => {
        let app = null;
        
        const initLive2D = async () => {
          try {
            // Check if Live2D is available
            if (!window.Live2D) {
              throw new Error('Live2D SDK not loaded');
            }

            // Create PIXI Application
            app = new PIXI.Application({
              width: 350,
              height: 450,
              transparent: true,
              antialias: true,
              resolution: window.devicePixelRatio || 1,
              autoDensity: true
            });
            
            appRef.current = app;
            containerRef.current.appendChild(app.view);

            // Load Live2D model using the older but stable approach
            // For now use a simplified placeholder since full Live2D integration is complex
            await loadSimpleAvatar(app, modelPath);
            
            setIsLoading(false);
          } catch (err) {
            console.error('Live2D init error:', err);
            setError(err.message);
            setIsLoading(false);
          }
        };
        
        initLive2D();
        
        return () => {
          if (app) app.destroy(true);
        };
      }, [modelPath]);

      // Update lip-sync value
      useEffect(() => {
        lipSyncRef.current = lipSyncValue;
      }, [lipSyncValue]);

      const loadSimpleAvatar = async (app, path) => {
        // Create a stylized avatar representation
        const container = new PIXI.Container();
        
        // Background hexagon
        const hex = new PIXI.Graphics();
        hex.beginFill(0x1a1a25);
        hex.lineStyle(3, parseInt(teamColor.replace('#', '0x')));
        
        // Draw hexagon
        const size = 120;
        const points = [];
        for (let i = 0; i < 6; i++) {
          const angle = (i * 60 - 30) * Math.PI / 180;
          points.push(
            175 + size * Math.cos(angle),
            225 + size * Math.sin(angle)
          );
        }
        hex.drawPolygon(points);
        hex.endFill();
        container.addChild(hex);
        
        // Character placeholder (circle with team color)
        const circle = new PIXI.Graphics();
        circle.beginFill(parseInt(teamColor.replace('#', '0x')));
        circle.drawCircle(175, 200, 60);
        circle.endFill();
        container.addChild(circle);
        
        // Face features
        const face = new PIXI.Graphics();
        face.beginFill(0xffffff);
        // Eyes
        face.drawCircle(155, 190, 8);
        face.drawCircle(195, 190, 8);
        // Mouth (animated)
        face.drawEllipse(175, 220, 20, 5);
        face.endFill();
        container.addChild(face);
        
        // Speaking ring
        const ring = new PIXI.Graphics();
        container.addChild(ring);
        
        // Animation loop
        app.ticker.add(() => {
          ring.clear();
          if (lipSyncRef.current > 0.1) {
            ring.lineStyle(4, parseInt(teamColor.replace('#', '0x')), 0.5 + lipSyncRef.current * 0.5);
            const ringSize = 130 + lipSyncRef.current * 20;
            const ringPoints = [];
            for (let i = 0; i < 6; i++) {
              const angle = (i * 60 - 30) * Math.PI / 180;
              ringPoints.push(
                175 + ringSize * Math.cos(angle),
                225 + ringSize * Math.sin(angle)
              );
            }
            ring.drawPolygon(ringPoints);
          }
        });
        
        app.stage.addChild(container);
      };

      return (
        <div className={`avatar-container ${isSpeaking ? 'speaking' : ''}`}>
          {isLoading && (
            <div className="loading-overlay">
              <div className="loading-spinner"></div>
              <div className="text-gray-400 mt-4">Loading {name}...</div>
            </div>
          )}
          {error && (
            <div className="loading-overlay">
              <div className="text-red-400 text-center px-4">
                <div>Failed to load avatar</div>
                <div className="text-xs mt-2 text-gray-500">{error}</div>
              </div>
            </div>
          )}
          <div ref={containerRef} className="avatar-canvas" />
          <div className="avatar-info">
            <div style={{ color: teamColor, fontWeight: 700, fontSize: '18px' }}>{name}</div>
            <div style={{ color: 'rgba(255,255,255,0.5)', fontSize: '12px', textTransform: 'uppercase' }}>
              {teamAbbr} Commentator
            </div>
            <div className="lip-sync-bar">
              <div className="lip-sync-fill" style={{ width: `${lipSyncValue * 100}%` }}></div>
            </div>
          </div>
        </div>
      );
    }

    // Main App
    function AvatarMode() {
      const [session, setSession] = useState(null);
      const [commentary, setCommentary] = useState([]);
      const [currentTurn, setCurrentTurn] = useState(0);
      const [isPlaying, setIsPlaying] = useState(false);
      const [lipSyncA, setLipSyncA] = useState(0);
      const [lipSyncB, setLipSyncB] = useState(0);
      const [currentSpeaker, setCurrentSpeaker] = useState(null);
      const [subtitle, setSubtitle] = useState({ speaker: '', text: 'Ready for commentary... Press Play to start' });
      
      const ttsRef = useRef(new SimpleTTS());

      // Get session from URL
      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const sessionId = params.get('session');
        
        if (sessionId) {
          fetch(`/api/sessions/${sessionId}`)
            .then(r => r.json())
            .then(data => {
              setSession(data);
              // Fetch initial commentary
              return fetch(`/api/sessions/${sessionId}/commentary/latest`);
            })
            .then(r => r.json())
            .then(data => {
              if (data.turns && data.turns.length > 0) {
                setCommentary(data.turns);
              }
            })
            .catch(console.error);
        }
      }, []);

      const playTurn = useCallback(async (index) => {
        if (index >= commentary.length) {
          setIsPlaying(false);
          setCurrentSpeaker(null);
          setLipSyncA(0);
          setLipSyncB(0);
          setSubtitle({ speaker: '', text: 'Commentary complete' });
          return;
        }
        
        const turn = commentary[index];
        setCurrentTurn(index);
        setCurrentSpeaker(turn.speaker);
        setSubtitle({ speaker: turn.name, text: turn.text });
        
        // Lip-sync animation
        let lipSyncInterval;
        const animateLipSync = () => {
          const value = Math.random();
          if (turn.speaker === 'A') {
            setLipSyncA(value);
            setLipSyncB(0);
          } else {
            setLipSyncB(value);
            setLipSyncA(0);
          }
        };
        
        lipSyncInterval = setInterval(animateLipSync, 50);
        
        // Speak
        await ttsRef.current.speak(turn.text);
        
        clearInterval(lipSyncInterval);
        setLipSyncA(0);
        setLipSyncB(0);
        
        // Pause between turns
        await new Promise(r => setTimeout(r, 800));
        
        // Next turn
        playTurn(index + 1);
      }, [commentary]);

      const handlePlay = async () => {
        // Fetch fresh commentary
        const params = new URLSearchParams(window.location.search);
        const sessionId = params.get('session');
        
        if (sessionId) {
          try {
            const res = await fetch(`/api/sessions/${sessionId}/commentary/latest`);
            const data = await res.json();
            if (data.turns && data.turns.length > 0) {
              setCommentary(data.turns);
              setCurrentTurn(0);
              setIsPlaying(true);
              playTurn(0);
            } else {
              setSubtitle({ speaker: '', text: 'No commentary available yet. Try again in a few seconds.' });
            }
          } catch (err) {
            setSubtitle({ speaker: 'Error', text: 'Failed to fetch commentary' });
          }
        }
      };

      const handlePause = () => {
        setIsPlaying(false);
        ttsRef.current.stop();
      };

      const handleSkip = () => {
        ttsRef.current.stop();
        playTurn(currentTurn + 1);
      };

      const commentatorA = session?.commentators?.[0] || { name: 'Hiyori', team: 'away' };
      const commentatorB = session?.commentators?.[1] || { name: 'Ren', team: 'home' };

      return (
        <div style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column' }}>
          {/* Header */}
          <div style={{ 
            padding: '16px 24px', 
            background: 'rgba(255,255,255,0.03)',
            borderBottom: '1px solid rgba(255,255,255,0.06)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
              <a href="/" style={{ color: 'rgba(255,255,255,0.5)' }}>
                <ArrowLeft size={20} />
              </a>
              <div>
                <div style={{ fontWeight: 700 }}>Avatar Mode</div>
                <div style={{ fontSize: '12px', color: 'rgba(255,255,255,0.5)' }}>
                  {session?.gameName || 'Live Commentary'}
                </div>
              </div>
            </div>
            <div style={{ display: 'flex', gap: '12px' }}>
              {!isPlaying ? (
                <button onClick={handlePlay} style={{
                  padding: '8px 16px',
                  background: 'rgba(255,184,28,0.2)',
                  border: '1px solid rgba(255,184,28,0.4)',
                  borderRadius: '8px',
                  color: '#FFB81C',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px',
                  cursor: 'pointer'
                }}>
                  <Play size={16} /> Play
                </button>
              ) : (
                <button onClick={handlePause} style={{
                  padding: '8px 16px',
                  background: 'rgba(255,255,255,0.1)',
                  border: '1px solid rgba(255,255,255,0.2)',
                  borderRadius: '8px',
                  color: 'white',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px',
                  cursor: 'pointer'
                }}>
                  <Pause size={16} /> Pause
                </button>
              )}
              <button onClick={handleSkip} style={{
                padding: '8px 16px',
                background: 'rgba(255,255,255,0.05)',
                border: '1px solid rgba(255,255,255,0.1)',
                borderRadius: '8px',
                color: 'rgba(255,255,255,0.7)',
                display: 'flex',
                alignItems: 'center',
                gap: '8px',
                cursor: 'pointer'
              }}>
                <SkipForward size={16} /> Skip
              </button>
            </div>
          </div>

          {/* Avatar Stage */}
          <div className="avatar-stage" style={{ flex: 1 }}>
            <div className="vs-badge">VS</div>
            
            <Live2DAvatar
              modelPath="/avatars/models/hiyori/hiyori_pro_t11.model3.json"
              name={commentatorA.name}
              teamColor={commentatorA.team === 'home' ? '#4a90d9' : '#ff6b35'}
              teamAbbr={commentatorA.team === 'home' ? 'HOME' : 'AWAY'}
              isSpeaking={currentSpeaker === 'A'}
              lipSyncValue={lipSyncA}
            />
            
            <Live2DAvatar
              modelPath="/avatars/models/ren/ren.model3.json"
              name={commentatorB.name}
              teamColor={commentatorB.team === 'home' ? '#4a90d9' : '#ff6b35'}
              teamAbbr={commentatorB.team === 'home' ? 'HOME' : 'AWAY'}
              isSpeaking={currentSpeaker === 'B'}
              lipSyncValue={lipSyncB}
            />
          </div>

          {/* Subtitles */}
          <div className="subtitle-box">
            <div style={{ fontSize: '11px', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '1px', color: '#FFB81C', marginBottom: '8px' }}>
              {subtitle.speaker || 'Commentary'}
            </div>
            <div style={{ fontSize: '20px', fontWeight: 500, color: 'rgba(255,255,255,0.9)' }}>
              {subtitle.text}
            </div>
          </div>

          {/* Controls */}
          <div className="controls-panel">
            <div style={{ display: 'flex', gap: '16px', justifyContent: 'center', flexWrap: 'wrap' }}>
              <div style={{ 
                padding: '12px 20px', 
                background: 'rgba(255,255,255,0.05)',
                borderRadius: '8px',
                fontSize: '13px'
              }}>
                <span style={{ color: 'rgba(255,255,255,0.5)' }}>TTS: </span>
                <span style={{ color: '#FFB81C' }}>Web Speech API</span>
              </div>
              <div style={{ 
                padding: '12px 20px', 
                background: 'rgba(255,255,255,0.05)',
                borderRadius: '8px',
                fontSize: '13px'
              }}>
                <span style={{ color: 'rgba(255,255,255,0.5)' }}>Models: </span>
                <span style={{ color: '#FFB81C' }}>Hiyori & Ren</span>
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<AvatarMode />);
  </script>
</body>
</html>
