<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arm Position Test</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script>window.react = window.React;</script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.169.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://unpkg.com/@pixiv/three-vrm@3/lib/three-vrm.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0a0a0a; color: #fff; font-family: system-ui, sans-serif; overflow: hidden; }
    #canvas { width: 100vw; height: 100vh; display: block; }
    .debug-panel {
      position: fixed;
      left: 20px;
      top: 20px;
      background: rgba(0,0,0,0.95);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 20px;
      width: 350px;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
      z-index: 100;
    }
    .debug-panel h1 {
      font-size: 16px;
      font-weight: 800;
      margin-bottom: 20px;
      letter-spacing: 1px;
    }
    .bone-section {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .bone-title {
      color: #60a5fa;
      font-weight: 700;
      margin-bottom: 12px;
      font-size: 13px;
    }
    .axis-control {
      margin-bottom: 8px;
    }
    .axis-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      font-size: 11px;
    }
    .axis-label span:first-child {
      text-transform: uppercase;
      opacity: 0.7;
    }
    .axis-label span:last-child {
      font-family: monospace;
      color: #fbbf24;
      font-weight: 600;
    }
    input[type="range"] {
      width: 100%;
      accent-color: #60a5fa;
    }
    .copy-btn {
      width: 100%;
      padding: 12px;
      background: #3b82f6;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 700;
      cursor: pointer;
      font-size: 12px;
      letter-spacing: 0.5px;
      margin-top: 10px;
    }
    .copy-btn:hover {
      background: #2563eb;
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>
  <div id="ui-root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    function App() {
      const [armValues, setArmValues] = useState({
        lua: { x: 0.15, y: 0.1, z: -1.3 },
        rua: { x: 0.15, y: -0.1, z: 1.3 },
        lla: { x: -0.6, y: 0.05, z: 0 },
        rla: { x: -0.6, y: -0.05, z: 0 },
        lh: { x: 0, y: 0, z: 0 },
        rh: { x: 0, y: 0, z: 0 }
      });

      const canvasRef = useRef(null);
      const vrmRef = useRef(null);
      const bonesRef = useRef(null);

      useEffect(() => {
        const canvas = document.getElementById('canvas');

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(30, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.35, 2.2);
        camera.lookAt(0, 1.25, 0);

        const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);

        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const key = new THREE.DirectionalLight(0xffeeb1, 1.5);
        key.position.set(-1, 2, 3);
        scene.add(key);

        const loader = new THREE.GLTFLoader();
        loader.register((parser) => new VRM.VRMLoaderPlugin(parser));

        // Load default VRM
        const modelUrl = '/avatars/sakura.vrm';
        loader.load(modelUrl, (gltf) => {
          const vrm = gltf.userData.vrm;
          VRM.VRMUtils.removeUnnecessaryJoints(gltf.scene);
          scene.add(vrm.scene);
          vrmRef.current = vrm;

          const humanoid = vrm.humanoid;
          const bones = {
            lua: humanoid.getNormalizedBoneNode('leftUpperArm'),
            rua: humanoid.getNormalizedBoneNode('rightUpperArm'),
            lla: humanoid.getNormalizedBoneNode('leftLowerArm'),
            rla: humanoid.getNormalizedBoneNode('rightLowerArm'),
            lhand: humanoid.getNormalizedBoneNode('leftHand'),
            rhand: humanoid.getNormalizedBoneNode('rightHand')
          };
          bonesRef.current = bones;

          console.log('[VRM] Model loaded, bones:', bones);
        });

        const animate = () => {
          requestAnimationFrame(animate);

          // Apply arm values to bones in real-time
          if (bonesRef.current) {
            const bones = bonesRef.current;
            const values = armValues;

            if (bones.lua) {
              bones.lua.rotation.x = values.lua.x;
              bones.lua.rotation.y = values.lua.y;
              bones.lua.rotation.z = values.lua.z;
            }
            if (bones.rua) {
              bones.rua.rotation.x = values.rua.x;
              bones.rua.rotation.y = values.rua.y;
              bones.rua.rotation.z = values.rua.z;
            }
            if (bones.lla) {
              bones.lla.rotation.x = values.lla.x;
              bones.lla.rotation.y = values.lla.y;
              bones.lla.rotation.z = values.lla.z;
            }
            if (bones.rla) {
              bones.rla.rotation.x = values.rla.x;
              bones.rla.rotation.y = values.rla.y;
              bones.rla.rotation.z = values.rla.z;
            }
            if (bones.lhand) {
              bones.lhand.rotation.x = values.lh.x;
              bones.lhand.rotation.y = values.lh.y;
              bones.lhand.rotation.z = values.lh.z;
            }
            if (bones.rhand) {
              bones.rhand.rotation.x = values.rh.x;
              bones.rhand.rotation.y = values.rh.y;
              bones.rhand.rotation.z = values.rh.z;
            }
          }

          if (vrmRef.current) {
            vrmRef.current.update(0.016);
          }
          renderer.render(scene, camera);
        };
        animate();

        const handleResize = () => {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        };
        window.addEventListener('resize', handleResize);

        return () => {
          window.removeEventListener('resize', handleResize);
          renderer.dispose();
        };
      }, [armValues]);

      const bones = [
        { key: 'lua', label: 'Left Upper Arm' },
        { key: 'rua', label: 'Right Upper Arm' },
        { key: 'lla', label: 'Left Lower Arm (Elbow)' },
        { key: 'rla', label: 'Right Lower Arm (Elbow)' },
        { key: 'lh', label: 'Left Hand' },
        { key: 'rh', label: 'Right Hand' }
      ];

      const copyValues = () => {
        const text = JSON.stringify(armValues, null, 2);
        navigator.clipboard.writeText(text);
        alert('Values copied to clipboard!');
      };

      return (
        <div className="debug-panel">
          <h1>ðŸ¦¾ ARM POSITION TEST</h1>
          {bones.map(bone => (
            <div key={bone.key} className="bone-section">
              <div className="bone-title">{bone.label}</div>
              {['x', 'y', 'z'].map(axis => (
                <div key={axis} className="axis-control">
                  <div className="axis-label">
                    <span>{axis}</span>
                    <span>{armValues[bone.key][axis].toFixed(2)}</span>
                  </div>
                  <input
                    type="range"
                    min="-3"
                    max="3"
                    step="0.05"
                    value={armValues[bone.key][axis]}
                    onChange={(e) => setArmValues(prev => ({
                      ...prev,
                      [bone.key]: { ...prev[bone.key], [axis]: parseFloat(e.target.value) }
                    }))}
                  />
                </div>
              ))}
            </div>
          ))}
          <button className="copy-btn" onClick={copyValues}>
            ðŸ“‹ COPY ALL VALUES
          </button>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('ui-root')).render(<App />);
  </script>
</body>
</html>
